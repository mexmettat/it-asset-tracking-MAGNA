<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Raporlar · MAGNA IT</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/magna-icon.png') }}">

  <style>
    :root{
      --brand-red:#E41E26;
      --ink:#101828;
      --muted:#475467;
      --line:#EAECF0;
      --green:#2E7D32;
      --amber:#F59E0B;
      --teal:#0E9384;
      --blue:#2563EB; /* Kullanımda */
    }
    body{background:#F6F7FA;color:var(--ink)}
    .navbar-dark .nav-link{font-weight:600}
    .navbar-dark .nav-link.active{color:#fff;border-bottom:2px solid var(--brand-red)}
    .card.mg{border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 18px rgba(16,24,40,.06)}
    .card-header{background:#fff;border-bottom:1px solid var(--line)}
    .section-title{font-weight:700;font-size:1.125rem}
    .subtle{color:var(--muted)}
    .chart-wrap{position:relative;height:340px}
    .chart-wrap.sm{height:300px}
    .legend-note{font-size:.85rem;color:var(--muted)}
    .footer{background:#f9fafb;color:#6b7280;text-align:center;padding:10px;font-size:14px;border-top:1px solid #e5e7eb;margin-top:20px;}
    .export-group { gap:.5rem; }
    .btn-export{
      display:inline-flex; align-items:center; gap:.5rem;
      border-radius:999px; padding:.45rem .9rem;
      font-weight:600; border:1px solid transparent;
      box-shadow:0 6px 14px rgba(16,24,40,.06);
      transition:.15s ease;
    }
    .btn-export i{ font-size:1.05rem; line-height:1; }

    .btn-soft-success{ background:#E8F5E9; color:#1E7E34; border-color:#C8E6C9; }
    .btn-soft-success:hover{ background:#DFF3E3; color:#155724; transform:translateY(-1px); }

    .btn-soft-danger{ background:#FDECEC; color:#B42318; border-color:#F8C7C7; }
    .btn-soft-danger:hover{ background:#FADADA; color:#912018; transform:translateY(-1px); }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark" style="background:#000;">
  <div class="container d-flex align-items-center">
    <a class="navbar-brand d-flex align-items-center me-3" href="{{ url_for('inventory') }}">
      <img src="{{ url_for('static', filename='img/magna-logo-navbar.png') }}" alt="MAGNA Logo" height="32" class="me-2">
      <span class="brand-subtitle">IT CİHAZ TAKİP UYGULAMASI</span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse flex-grow-0" id="nav">
      <ul class="navbar-nav ms-3">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('inventory') }}">Depo Envanteri</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('faults') }}">Arızalı Cihazlar</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('inuse') }}">Kullanımdaki Cihazlar</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('service') }}">Servis Geçmişi</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('params') }}">Parametreler</a></li>
        <li class="nav-item"><a class="nav-link active" href="{{ url_for('reports') }}">Raporlar</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('kullanim') }}">Nasıl Çalışır</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-4">
  <div class="alert alert-primary small">
    <strong>Kullanım ipucu:</strong> Grafiklerde çubukların üzerinde değerler gösterilir. Eksen adları ve grid çizgileri analizi kolaylaştırır.
  </div>

  <!-- GENEL KART -->
  <div class="card mg mb-4">
    <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
      <div>
        <div class="section-title mb-0">Genel Durum Raporları</div>
        <div class="subtle">Toplam cihazların mevcut durum dağılımı ve markaya göre özet.</div>
      </div>

      <div class="d-flex export-group">
        <a class="btn btn-export btn-soft-success"
          href="{{ url_for('reports_download_excel') or '/reports/download/excel' }}"
          title="Excel olarak indir" rel="noopener">
          <i class="bi bi-file-earmark-excel"></i><span>Excel</span>
        </a>
        <a class="btn btn-export btn-soft-danger"
          href="{{ url_for('reports_download_pdf') or '/reports/download/pdf' }}"
          title="PDF olarak indir" rel="noopener">
          <i class="bi bi-filetype-pdf"></i><span>PDF</span>
        </a>
      </div>

    </div>
    <div class="card-body">
      <div class="row g-4">
        <div class="col-lg-5">
          <div class="chart-wrap"><canvas id="donutGeneral"></canvas></div>
          <div class="legend-note mt-2">
            <strong>Kullanımda</strong> + <strong>Serviste</strong> + <strong>Arızalı Depoda</strong> + <strong>Sağlam Depoda</strong> toplamı, tüm cihaz adedini verir.
          </div>

          <h6 class="subtle mt-4">Markaya Göre Toplam (Stack)</h6>
          <div class="chart-wrap sm"><canvas id="barTotalBrand"></canvas></div>
        </div>

        <div class="col-lg-7">
          <div class="row g-4">
            <div class="col-12">
              <h6 class="subtle">Markaya Göre Sağlam</h6>
              <div class="chart-wrap sm"><canvas id="barHealthyBrand"></canvas></div>
            </div>
            <div class="col-12">
              <h6 class="subtle">Markaya Göre Arızalı</h6>
              <div class="chart-wrap sm"><canvas id="barFaultyBrand"></canvas></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DAĞILIMLAR KARTI -->
  <div class="card mg mb-4">
    <div class="card-header">
      <div class="section-title mb-0">Marka & Tip Bazlı Dağılımlar</div>
      <div class="subtle">Depodaki sağlam / arızalı, servisteki ve kullanımda olan cihazların tip kırılımları.</div>
    </div>
    <div class="card-body">
      <div class="row g-4">
        <div class="col-md-6">
          <h6 class="subtle">Servisteki Cihazlar (Marka)</h6>
          <div class="chart-wrap sm"><canvas id="barServiceBrand"></canvas></div>
        </div>
        <div class="col-md-6">
          <h6 class="subtle">Servisteki Cihazlar (Tip)</h6>
          <div class="chart-wrap sm"><canvas id="barServiceType"></canvas></div>
        </div>
        <div class="col-md-6">
          <h6 class="subtle">Depodaki Sağlam Cihazlar (Tip)</h6>
          <div class="chart-wrap sm"><canvas id="barHealthyType"></canvas></div>
        </div>
        <div class="col-md-6">
          <h6 class="subtle">Arızalı Cihazlar (Tip)</h6>
          <div class="chart-wrap sm"><canvas id="barFaultyType"></canvas></div>
        </div>

        <div class="col-md-6">
          <h6 class="subtle">Kullanımda (Tip)</h6>
          <div class="chart-wrap sm"><canvas id="barInuseType"></canvas></div>
        </div>
        <div class="col-md-6">
          <h6 class="subtle">Kullanımda (Marka)</h6>
          <div class="chart-wrap sm"><canvas id="barInuseBrand"></canvas></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<!-- Sunucudan gelen rapor verileri -->
<script id="reportData" type="application/json">
{{ {
  "healthy_count": healthy_count|default(0)|int,
  "faulty_count": faulty_count|default(0)|int,
  "service_count": service_count|default(0)|int,
  "inuse_count":   inuse_count|default(0)|int,

  "healthy_brand_labels": healthy_brand_labels|default([], true),
  "healthy_brand_values": healthy_brand_values|default([], true),
  "faulty_brand_labels":  faulty_brand_labels|default([], true),
  "faulty_brand_values":  faulty_brand_values|default([], true),
  "service_brand_labels": service_brand_labels|default([], true),
  "service_brand_values": service_brand_values|default([], true),
  "inuse_brand_labels":   inuse_brand_labels|default([], true),
  "inuse_brand_values":   inuse_brand_values|default([], true),

  "healthy_type_labels": healthy_type_labels|default([], true),
  "healthy_type_values": healthy_type_values|default([], true),
  "faulty_type_labels":  faulty_type_labels|default([], true),
  "faulty_type_values":  faulty_type_values|default([], true),
  "service_type_labels": service_type_labels|default([], true),
  "service_type_values": service_type_values|default([], true),
  "inuse_type_labels":   inuse_type_labels|default([], true),
  "inuse_type_values":   inuse_type_values|default([], true),

  "inuse_user_labels":   inuse_user_labels|default([], true),
  "inuse_user_values":   inuse_user_values|default([], true)
} | tojson }}
</script>

<script>
  const D = JSON.parse(document.getElementById('reportData').textContent);
  const red=getCss('--brand-red'), green=getCss('--green'), amber=getCss('--amber'), teal=getCss('--teal'), grid=getCss('--line'), blue=getCss('--blue');
  function getCss(n){return getComputedStyle(document.documentElement).getPropertyValue(n).trim();}
  Chart.defaults.font.family=`"Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial`;
  const baseOpts={maintainAspectRatio:false,plugins:{legend:{labels:{boxWidth:12,usePointStyle:true}}},layout:{padding:{top:8,right:12,bottom:8,left:12}}};
  const axis=t=>({grid:{color:grid},ticks:{autoSkip:false,maxRotation:0,minRotation:0,font:{size:12}},title:{display:true,text:t,font:{weight:'600'}}});
  const valueLabels={color:'#344054',anchor:'end',align:'top',offset:4,font:{weight:'600',size:11},formatter:v=>(v??0)};

  /* Donut */
  new Chart(document.getElementById('donutGeneral'),{
    type:'doughnut',
    data:{
      labels:['Kullanımda','Serviste','Arızalı Depoda','Sağlam Depoda'],
      datasets:[{
        data:[D.inuse_count, D.service_count, D.faulty_count, D.healthy_count],
        backgroundColor:[blue, amber, red, green],
        borderWidth:1, borderColor:'#fff', hoverOffset:8
      }]
    },
    options:{
      ...baseOpts,
      plugins:{
        legend:{position:'bottom'},
        datalabels:{
          color:'#111',
          formatter:(v,ctx)=>{
            const total=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+(b||0),0)||1;
            const pct=Math.round((v/total)*100);
            return `${v} • ${pct}%`;
          },
          font:{weight:'600'}
        }
      },
      cutout:'58%'
    },
    plugins:[ChartDataLabels]
  });

  function makeBar(id, labels, values, color, xTitle, yTitle){
    return new Chart(document.getElementById(id), {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          data: values,
          backgroundColor: color,
          borderRadius: 6,
          maxBarThickness: 46
        }]
      },
      options: {
        ...baseOpts,
        plugins: {
          legend: { display: false },
          tooltip: { enabled: true },
          datalabels: valueLabels
        },
        layout: { padding: { bottom: 8 } },
        scales: {
          x: {
            ...axis(xTitle),
            grid: { display: false },
            ticks: {
              autoSkip: false,
              maxRotation: 45,
              minRotation: 45,
              font: { size: 11 }
            }
          },
          y: {
            ...axis(yTitle),
            beginAtZero: true,
            ticks: { stepSize: 1, precision: 0 }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  /* Stack - markaya göre toplam (Sağlam/Arızalı/Servis/Kullanımda) */
  function buildStackedBrand(){
    const set=new Set([
      ...(D.healthy_brand_labels||[]),
      ...(D.faulty_brand_labels||[]),
      ...(D.service_brand_labels||[]),
      ...(D.inuse_brand_labels||[])
    ]);
    const labels=Array.from(set).sort((a,b)=>String(a).localeCompare(String(b),'tr'));
    const pick=(L,V)=>labels.map(l=>{const i=(L||[]).indexOf(l);return i>=0?((V||[])[i]||0):0;});
    const healthy=pick(D.healthy_brand_labels,D.healthy_brand_values);
    const faulty =pick(D.faulty_brand_labels ,D.faulty_brand_values );
    const service=pick(D.service_brand_labels,D.service_brand_values);
    const inuse  =pick(D.inuse_brand_labels ,D.inuse_brand_values );
    const total=labels.map((_,i)=>healthy[i]+faulty[i]+service[i]+inuse[i]);
    return {labels,healthy,faulty,service,inuse,total};
  }
  const STACK=buildStackedBrand();

  /* Sağlam / Arızalı tekli barlar */
  makeBar('barHealthyBrand',D.healthy_brand_labels,D.healthy_brand_values,teal,'Marka','Adet');
  makeBar('barFaultyBrand' ,D.faulty_brand_labels ,D.faulty_brand_values ,red ,'Marka','Adet');

  /* Kullanımda (Marka/Tip/Kullanıcı) */
  makeBar('barInuseBrand', D.inuse_brand_labels, D.inuse_brand_values, blue, 'Marka', 'Adet');
  makeBar('barInuseType',  D.inuse_type_labels,  D.inuse_type_values,  blue, 'Tip',   'Adet');

  /* Stack bar */
  new Chart(document.getElementById('barTotalBrand'),{
    type:'bar',
    data:{
      labels: STACK.labels,
      datasets:[
        {label:'Sağlam',     data:STACK.healthy, backgroundColor:teal,  borderRadius:6, maxBarThickness:46},
        {label:'Arızalı',    data:STACK.faulty,  backgroundColor:red,   borderRadius:6, maxBarThickness:46},
        {label:'Serviste',   data:STACK.service, backgroundColor:amber, borderRadius:6, maxBarThickness:46},
        {label:'Kullanımda', data:STACK.inuse,   backgroundColor:blue,  borderRadius:6, maxBarThickness:46},
      ]
    },
    options:{
      ...baseOpts,
      plugins:{ legend:{position:'bottom'}, tooltip:{enabled:true}, datalabels:{display:false} },
      layout:{ padding:{ bottom:8 } },
      scales:{
        x:{
          ...axis('Marka'),
          stacked:true,
          grid:{ display:false },
          ticks:{ autoSkip:false, maxRotation:45, minRotation:45, font:{ size:11 } }
        },
        y:{
          ...axis('Adet'),
          stacked:true,
          beginAtZero:true,
          ticks:{ stepSize:1, precision:0 }
        }
      }
    }
  });

  /* Diğer barlar */
  makeBar('barServiceBrand',D.service_brand_labels,D.service_brand_values,amber,'Marka','Adet');
  makeBar('barHealthyType' ,D.healthy_type_labels ,D.healthy_type_values ,teal ,'Tip','Adet');
  makeBar('barFaultyType'  ,D.faulty_type_labels  ,D.faulty_type_values  ,red  ,'Tip','Adet');
  makeBar('barServiceType' ,D.service_type_labels ,D.service_type_values ,amber,'Tip','Adet');
</script>

<footer class="footer"><p>© 2025 Cihaz Takip Sistemi</p></footer>
</body>
</html>
