<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Raporlar Â· MAGNA IT</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/magna-icon.png') }}">

  <style>
    :root{
      --brand-red:#E41E26;
      --ink:#101828;
      --muted:#475467;
      --line:#EAECF0;
      --green:#2E7D32;
      --amber:#F59E0B;
      --teal:#0E9384;
    }
    body{background:#F6F7FA;color:var(--ink)}
    .navbar-dark .nav-link{font-weight:600}
    .navbar-dark .nav-link.active{color:#fff;border-bottom:2px solid var(--brand-red)}
    .card.mg{border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 18px rgba(16,24,40,.06)}
    .card-header{background:#fff;border-bottom:1px solid var(--line)}
    .section-title{font-weight:700;font-size:1.125rem}
    .subtle{color:var(--muted)}
    .chart-wrap{position:relative;height:340px}
    .chart-wrap.sm{height:300px}
    .legend-note{font-size:.85rem;color:var(--muted)}
    .footer{background:#f9fafb;color:#6b7280;text-align:center;padding:10px;font-size:14px;border-top:1px solid #e5e7eb;margin-top:20px;}
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark" style="background:#000;">
  <div class="container d-flex align-items-center">
    <a class="navbar-brand d-flex align-items-center me-3" href="{{ url_for('inventory') }}">
      <img src="{{ url_for('static', filename='img/magna-logo-navbar.png') }}" alt="MAGNA Logo" height="32" class="me-2">
      <span class="brand-subtitle">IT CÄ°HAZ TAKÄ°P UYGULAMASI</span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse flex-grow-0" id="nav">
      <ul class="navbar-nav ms-3">
        <li class="nav-item"><a class="nav-link" href="{{ url_for('inventory') }}">Depo Envanteri</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('faults') }}">ArÄ±zalÄ± Cihazlar</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('service') }}">Servis GeÃ§miÅŸi</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('params') }}">Parametreler</a></li>
        <li class="nav-item"><a class="nav-link active" href="{{ url_for('reports') }}">Raporlar</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('kullanim') }}">NasÄ±l Ã‡alÄ±ÅŸÄ±r</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container my-4">
  <div class="alert alert-primary small">
    <strong>KullanÄ±m ipucu:</strong> Grafiklerde Ã§ubuklarÄ±n Ã¼zerinde deÄŸerler gÃ¶sterilir. Eksen adlarÄ± ve grid Ã§izgileri analizi kolaylaÅŸtÄ±rÄ±r.
  </div>

  <div class="card mg mb-4">
    <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
      <div>
        <div class="section-title mb-0">Genel Durum RaporlarÄ±</div>
        <div class="subtle">Toplam cihazlarÄ±n mevcut durum daÄŸÄ±lÄ±mÄ± ve markaya gÃ¶re Ã¶zet.</div>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-success btn-sm" href="{{ url_for('reports_download_excel') or '/reports/download/excel' }}">ğŸ“¥ Excel</a>
        <a class="btn btn-danger btn-sm"  href="{{ url_for('reports_download_pdf') or '/reports/download/pdf' }}">ğŸ“¥ PDF</a>
      </div>
    </div>
    <div class="card-body">
      <div class="row g-4">
        <div class="col-lg-5">
          <div class="chart-wrap"><canvas id="donutGeneral"></canvas></div>
          <div class="legend-note mt-2">Serviste + ArÄ±zalÄ± Depoda + SaÄŸlam Depoda toplamÄ± tÃ¼m cihaz adedini verir.</div>
          <h6 class="subtle mt-4">Markaya GÃ¶re Toplam (Stack)</h6>
          <div class="chart-wrap sm"><canvas id="barTotalBrand"></canvas></div>
        </div>
        <div class="col-lg-7">
          <div class="row g-4">
            <div class="col-12">
              <h6 class="subtle">Markaya GÃ¶re SaÄŸlam</h6>
              <div class="chart-wrap sm"><canvas id="barHealthyBrand"></canvas></div>
            </div>
            <div class="col-12">
              <h6 class="subtle">Markaya GÃ¶re ArÄ±zalÄ±</h6>
              <div class="chart-wrap sm"><canvas id="barFaultyBrand"></canvas></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mg mb-4">
    <div class="card-header">
      <div class="section-title mb-0">Marka & Tip BazlÄ± DaÄŸÄ±lÄ±mlar</div>
      <div class="subtle">Depodaki saÄŸlam / arÄ±zalÄ± ve servisteki cihazlarÄ±n marka/tip kÄ±rÄ±lÄ±mlarÄ±</div>
    </div>
    <div class="card-body">
      <div class="row g-4">
        <div class="col-md-6">
          <h6 class="subtle">Servisteki Cihazlar (Marka)</h6>
          <div class="chart-wrap sm"><canvas id="barServiceBrand"></canvas></div>
        </div>
        <div class="col-md-6">
          <h6 class="subtle">Servisteki Cihazlar (Tip)</h6>
          <div class="chart-wrap sm"><canvas id="barServiceType"></canvas></div>
        </div>
        <div class="col-md-6">
          <h6 class="subtle">Depodaki SaÄŸlam Cihazlar (Tip)</h6>
          <div class="chart-wrap sm"><canvas id="barHealthyType"></canvas></div>
        </div>
        <div class="col-md-6">
          <h6 class="subtle">ArÄ±zalÄ± Cihazlar (Tip)</h6>
          <div class="chart-wrap sm"><canvas id="barFaultyType"></canvas></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script id="reportData" type="application/json">
{{ {
  "healthy_count": healthy_count|default(0)|int,
  "faulty_count": faulty_count|default(0)|int,
  "service_count": service_count|default(0)|int,
  "healthy_brand_labels": healthy_brand_labels|default([], true),
  "healthy_brand_values": healthy_brand_values|default([], true),
  "faulty_brand_labels":  faulty_brand_labels|default([], true),
  "faulty_brand_values":  faulty_brand_values|default([], true),
  "service_brand_labels": service_brand_labels|default([], true),
  "service_brand_values": service_brand_values|default([], true),
  "healthy_type_labels": healthy_type_labels|default([], true),
  "healthy_type_values": healthy_type_values|default([], true),
  "faulty_type_labels":  faulty_type_labels|default([], true),
  "faulty_type_values":  faulty_type_values|default([], true),
  "service_type_labels": service_type_labels|default([], true),
  "service_type_values": service_type_values|default([], true)
} | tojson }}
</script>

<script>
  const D = JSON.parse(document.getElementById('reportData').textContent);
  const red=getCss('--brand-red'), green=getCss('--green'), amber=getCss('--amber'), teal=getCss('--teal'), grid=getCss('--line');
  function getCss(n){return getComputedStyle(document.documentElement).getPropertyValue(n).trim();}
  Chart.defaults.font.family=`"Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial`;
  const baseOpts={maintainAspectRatio:false,plugins:{legend:{labels:{boxWidth:12,usePointStyle:true}}},layout:{padding:{top:8,right:12,bottom:8,left:12}}};
  const axis=t=>({grid:{color:grid},ticks:{autoSkip:false,maxRotation:0,minRotation:0,font:{size:12}},title:{display:true,text:t,font:{weight:'600'}}});
  const valueLabels={color:'#344054',anchor:'end',align:'top',offset:4,font:{weight:'600',size:11},formatter:v=>(v??0)};

  new Chart(document.getElementById('donutGeneral'),{
    type:'doughnut',
    data:{labels:['Serviste','ArÄ±zalÄ± Depoda','SaÄŸlam Depoda'],
      datasets:[{data:[D.service_count,D.faulty_count,D.healthy_count],backgroundColor:[amber,red,green],borderWidth:1,borderColor:'#fff',hoverOffset:8}]},
    options:{...baseOpts,plugins:{legend:{position:'bottom'},datalabels:{color:'#111',formatter:(v,ctx)=>{const total=ctx.chart.data.datasets[0].data.reduce((a,b)=>a+(b||0),0)||1;const pct=Math.round((v/total)*100);return `${v} â€¢ ${pct}%`;},font:{weight:'600'}}},cutout:'58%'},plugins:[ChartDataLabels]
  });

  function makeBar(id,labels,values,color,xTitle,yTitle){
    return new Chart(document.getElementById(id),{type:'bar',
      data:{labels,datasets:[{data:values,backgroundColor:color,borderRadius:6,maxBarThickness:46}]},
      options:{...baseOpts,plugins:{legend:{display:false},tooltip:{enabled:true},datalabels:valueLabels},
        scales:{x:axis(xTitle),y:{...axis(yTitle),beginAtZero:true,ticks:{stepSize:1,precision:0}}}},plugins:[ChartDataLabels]
    });
  }

  function buildStackedBrand(){
    const set=new Set([...(D.healthy_brand_labels||[]),...(D.faulty_brand_labels||[]),...(D.service_brand_labels||[])]);
    const labels=Array.from(set).sort((a,b)=>String(a).localeCompare(String(b),'tr'));
    const pick=(L,V)=>labels.map(l=>{const i=(L||[]).indexOf(l);return i>=0?((V||[])[i]||0):0;});
    const healthy=pick(D.healthy_brand_labels,D.healthy_brand_values);
    const faulty =pick(D.faulty_brand_labels ,D.faulty_brand_values );
    const service=pick(D.service_brand_labels,D.service_brand_values);
    const total=labels.map((_,i)=>healthy[i]+faulty[i]+service[i]);
    return {labels,healthy,faulty,service,total};
  }
  const STACK=buildStackedBrand();

  makeBar('barHealthyBrand',D.healthy_brand_labels,D.healthy_brand_values,teal,'Marka','Adet');
  makeBar('barFaultyBrand' ,D.faulty_brand_labels ,D.faulty_brand_values ,red ,'Marka','Adet');

  new Chart(document.getElementById('barTotalBrand'),{
    type:'bar',
    data:{labels:STACK.labels,datasets:[
      {label:'SaÄŸlam',data:STACK.healthy,backgroundColor:teal,borderRadius:6,maxBarThickness:46},
      {label:'ArÄ±zalÄ±',data:STACK.faulty ,backgroundColor:red ,borderRadius:6,maxBarThickness:46},
      {label:'Serviste',data:STACK.service,backgroundColor:amber,borderRadius:6,maxBarThickness:46},
    ]},
    options:{...baseOpts,plugins:{legend:{position:'bottom'},tooltip:{enabled:true},datalabels:{display:false}},
      scales:{x:{...axis('Marka'),stacked:true},y:{...axis('Adet'),stacked:true,beginAtZero:true,ticks:{stepSize:1,precision:0}}}
    }
  });

  makeBar('barServiceBrand',D.service_brand_labels,D.service_brand_values,amber,'Marka','Adet');
  makeBar('barHealthyType' ,D.healthy_type_labels ,D.healthy_type_values ,teal ,'Tip','Adet');
  makeBar('barFaultyType'  ,D.faulty_type_labels  ,D.faulty_type_values  ,red  ,'Tip','Adet');
  makeBar('barServiceType' ,D.service_type_labels ,D.service_type_values ,amber,'Tip','Adet');

  function buildCsv(){
    const lines=[]; const push=(title,labels,values,col1)=>{lines.push(title);lines.push(`${col1},Adet`);(labels||[]).forEach((l,i)=>lines.push(`"${l}",${(values&&values[i]!=null)?values[i]:''}`));lines.push("");};
    lines.push("Ã–zet");lines.push("Durum,Adet");
    lines.push(`Serviste,${D.service_count}`);lines.push(`ArÄ±zalÄ± Depoda,${D.faulty_count}`);lines.push(`SaÄŸlam Depoda,${D.healthy_count}`);lines.push("");
    push("SaÄŸlam - Marka",D.healthy_brand_labels,D.healthy_brand_values,"Marka");
    push("ArÄ±zalÄ± - Marka",D.faulty_brand_labels ,D.faulty_brand_values ,"Marka");
    push("Servis - Marka" ,D.service_brand_labels,D.service_brand_values,"Marka");
    push("SaÄŸlam - Tip"  ,D.healthy_type_labels ,D.healthy_type_values ,"Tip");
    push("ArÄ±zalÄ± - Tip" ,D.faulty_type_labels  ,D.faulty_type_values  ,"Tip");
    push("Servis - Tip"  ,D.service_type_labels ,D.service_type_values ,"Tip");
    lines.push("Toplam - Marka (SaÄŸlam/ArÄ±zalÄ±/Serviste/Toplam)");
    lines.push("Marka,SaÄŸlam,ArÄ±zalÄ±,Serviste,Toplam");
    STACK.labels.forEach((l,i)=>{const h=STACK.healthy[i]||0,f=STACK.faulty[i]||0,s=STACK.service[i]||0,t=STACK.total[i]||h+f+s;lines.push(`"${l}",${h},${f},${s},${t}`);});
    lines.push(""); return lines.join("\n");
  }

  function download(filename,content,mime){const blob=new Blob([content],{type:mime});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(url);a.remove();},0);}

  document.getElementById('btnCsv').addEventListener('click',()=>{const csv=buildCsv();const stamp=new Date().toISOString().slice(0,10);download(`raporlar_${stamp}.csv`,csv,'text/csv;charset=utf-8;');});

  document.getElementById('btnXlsx').addEventListener('click',()=>{
    const wb=XLSX.utils.book_new();
    const summary=[["Durum","Adet"],["Serviste",D.service_count],["ArÄ±zalÄ± Depoda",D.faulty_count],["SaÄŸlam Depoda",D.healthy_count]];
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(summary),"Ã–zet");
    const add=(title,labels,values,col1)=>{const rows=[[col1,"Adet"]];(labels||[]).forEach((l,i)=>rows.push([l,(values&&values[i])||0]));XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(rows),title);};
    add("SaÄŸlam-Marka",D.healthy_brand_labels,D.healthy_brand_values,"Marka");
    add("ArÄ±zalÄ±-Marka" ,D.faulty_brand_labels ,D.faulty_brand_values ,"Marka");
    add("Servis-Marka"  ,D.service_brand_labels,D.service_brand_values,"Marka");
    add("SaÄŸlam-Tip"    ,D.healthy_type_labels ,D.healthy_type_values ,"Tip");
    add("ArÄ±zalÄ±-Tip"   ,D.faulty_type_labels  ,D.faulty_type_values  ,"Tip");
    add("Servis-Tip"    ,D.service_type_labels ,D.service_type_values ,"Tip");
    const total=[["Marka","SaÄŸlam","ArÄ±zalÄ±","Serviste","Toplam"]];
    STACK.labels.forEach((l,i)=>total.push([l,STACK.healthy[i]||0,STACK.faulty[i]||0,STACK.service[i]||0,STACK.total[i]||((STACK.healthy[i]||0)+(STACK.faulty[i]||0)+(STACK.service[i]||0))]));
    XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(total),"Toplam-Marka");
    const stamp=new Date().toISOString().slice(0,10);
    XLSX.writeFile(wb,`raporlar_${stamp}.xlsx`);
  });
</script>

<footer class="footer"><p>Â© 2025 Cihaz Takip Sistemi</p></footer>
</body>
</html>
